<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Задание 2. Виджет погоды с саджестом городов</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <style>
        .form-group {
            display: flex;
            gap: 5px;
        }

        .weatherContainer {
            display: flex;
            align-items: center;
            flex-direction: column
        }

        .iconSize {
            width: 50px;
            height: 50px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-6 m-auto">
                <h3 class="text-center mb-3">
                    Weather Widget
                </h3>
                <div class="form-group">
                    <input type="text" class="form-control form-control-lg search" placeholder="Введите название города...">
                    <button class="button btn btn-primary">Показать погоду</button>
                </div>
                <div class="match-list"></div>
                <div class="weatherContainer">
                    <img class="icon">
                    <div class="weatherCondition"></div>
                    <div><div class="temperature"></div></div>
                </div>
            </div>
        </div>
    </div>
    <script src="/3 курс/Урок 3.15/request.js"></script>
    <script>
        // САДЖЕСТ
        const search = document.querySelector('.search');
        const matchList = document.querySelector('.match-list');
        
        const searchCity = async searchText  => {
            const res = await fetch('cities.json');
            const cities = await res.json();

            let matches = cities.filter(city => {
                        const regex = new RegExp(`^${searchText}`, 'gi');
                        return city.city.match(regex)
                    })

                    if (searchText.length === 0) {
                        matches = [];
                        matchList.innerHTML = '';
                    }
            outputHtml(matches);
        }

        search.addEventListener('input', () => searchCity(search.value))

        const outputHtml = matches => {
            if (matches.length > 0) {
                const html = matches
                .map(
                    match => `
                    <div class="card card-body">
                    <h4>${match.city}</h4></div>`
                )
                .join('');

                matchList.innerHTML = html;

                // КЛИКАБЕЛЬНОСТЬ САДЖЕСТА

                matchList.addEventListener('click', function(e) {
                    let cityWeather = matches[0];
                    search.value = cityWeather.city;
                    matchList.innerHTML = ''
                })

                // matchList.addEventListener('click', function(e) {
                //     for (let i = 0; i < matches.length; i++){
                //         let cityWeather = this.matches;
                //         search.value = cityWeather.city;
                //         matchList.innerHTML = ''  
                //     }
                    
                // })
            }
        }

        const button = document.querySelector('.button');
        const weatherCondition = document.querySelector('.weatherCondition');
        const temperature = document.querySelector('.temperature');
        const icon = document.querySelector('.icon');
        
        button.addEventListener('click', function(e) {
            const APP_ID = '563cf15d560589aa621c7b4318b71315'
            const API_BASE_URL = 'https://api.openweathermap.org/data/2.5'
            const city = search.value
            
            request({
                url: `${API_BASE_URL}/weather`,
                params: {
                    q: city,
                    appid: APP_ID,
                },

                onSuccess: (data) => {
                    weatherCondition.textContent = data.weather[0].description;
                    temperature.textContent = 'Температура:' + Math.trunc(data.main.temp - 273.15) ;
                    const iconID = data.weather[0].icon;
                    icon.src = `http://openweathermap.org/img/wn/${iconID}@2x.png`;
                    icon.classList.add('iconSize');

                }
            })
        })
    </script>
</body>
</html>